<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>ARMS - Drivers Scout</title>
    <link rel="stylesheet" href="./assets/style.css"/>
    <link rel="icon" href="./assets/favicon.ico" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
<header>
    <h1>Drivers Scout – Top iRating Gainers</h1>
</header>

<main>
    <!-- License gate -->
    <section id="auth" class="card">
        <p>Validate your license key to enter the dashboard, filter gainers, and explore their iRating gains.</p>
        <label for="license-input">License key</label>
        <input id="license-input" placeholder="Insert your 25 character license key here"/>
        <button id="license-check">Validate</button>
        <div id="license-status" class="status"></div>
    </section>

    <!-- Dashboard -->
    <section id="dashboard" class="card hidden">
        <h2>Dashboard</h2>
        <div class="filters">
            <label>Category
                <select id="category" value="sports_car">
                    <option value="sports_car" selected>Sports Car</option>
                    <option value="formula_car">Formula Car</option>
                </select>
            </label>
            <label>Days
                <input id="days" type="number" min="1" value="30"/>
            </label>
            <label>Limit
                <input id="limit" type="number" min="1" max="100" value="20"/>
            </label>
            <label>Min current iRating
                <input id="minIr" type="number" min="0" placeholder="(optional)"/>
            </label>
            <button id="run-query">Load Gainers</button>
        </div>

        <div id="results" hidden>
            <header id="rangeHeader" class="range-header">
                <div class="range-title">Time range</div>
                <div id="rangeText" class="range-text"></div>
            </header>
            <section style="max-height: 40vh">
                <canvas id="chart"></canvas>
            </section>
            <table id="table">
                <thead>
                <tr>
                    <th>#</th>
                    <th>Driver</th>
                    <th>Current iRating</th>
                    <th>Δ iRating</th>
                    <th>% Change</th>
                    <th>Starts</th>
                    <th>Wins</th>
                    <th>Location</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </section>
    <footer style="margin-top:2rem; padding:1rem 0; text-align:center; color:#94a3b8; font-size:0.9rem;">
        © <span id="year"></span> AR Media Solutions. All rights reserved.
    </footer>
</main>

<script>
    const auth = document.getElementById('auth')
    const licenseInput = document.getElementById('license-input');
    const licenseCheck = document.getElementById('license-check');
    const licenseStatus = document.getElementById('license-status');
    const dashboard = document.getElementById('dashboard');
    const runQuery = document.getElementById('run-query');
    const tableBody = document.querySelector('#table tbody');
    const results = document.getElementById('results');
    let licenseKey = sessionStorage.getItem('ARMS-License-Key');
    let chart = null;
    const rangeHeader = document.getElementById('rangeHeader');
    const rangeText = document.getElementById('rangeText');

    function formatIsoDateHuman(isoDate) {
        if (!isoDate) return null;
        // "YYYY-MM-DD" -> force UTC to avoid timezone shifting
        const d = new Date(`${isoDate}T00:00:00Z`);
        if (Number.isNaN(d.getTime())) return null;
        return new Intl.DateTimeFormat(navigator.language || 'en-US', {
            year: 'numeric', month: 'long', day: '2-digit', timeZone: 'UTC'
        }).format(d);
    }

    function renderTimeRange(startIso, endIso) {
        const start = formatIsoDateHuman(startIso);
        const end = formatIsoDateHuman(endIso);

        if (!start && !end) {
            rangeHeader.hidden = true;
            rangeText.textContent = '';
            return;
        }

        rangeHeader.hidden = false;
        rangeText.textContent = start && end ? `${start} to ${end}` : (start || end);
    }

    function setStatus(msg, ok = false) {
        licenseStatus.textContent = msg;
        licenseStatus.className = 'status ' + (ok ? 'ok' : 'err');
    }

    async function checkLicense(key) {
        if (!key) {
            setStatus('Enter a license key');
            return;
        }
        setStatus('Checking...');
        try {
            const res = await fetch(`/drivers-scout/api/licenses/${encodeURIComponent(key)}/status`);

            if (res.status === 502) {
                setStatus('Server not reachable. Try again later.');
                return;
            }

            if (!res.ok) {
                setStatus('Could not verify license.');
                return;
            }

            const data = await res.json();
            if (data.valid && data.active) {
                licenseKey = key;
                dashboard.classList.remove('hidden');
                setStatus('License active. Dashboard unlocked.', true);
                sessionStorage.setItem('ARMS-License-Key', key)
                auth.hidden = true;
            } else {
                dashboard.classList.add('hidden');
                setStatus('License invalid or inactive.');
            }
        } catch (err) {
            console.error(err);
            setStatus('Could not verify license.');
        }
    }

    function setLoading(isLoading) {
        runQuery.disabled = isLoading
        runQuery.innerHTML = isLoading ? "Loading..." : "Load Gainers"
    }

    async function loadGainers() {
        if (!licenseKey) {
            setStatus('Validate a license first');
            return;
        }
        setLoading(true)
        console.log(document.getElementById('category').value)
        const params = new URLSearchParams();
        params.set('category', document.getElementById('category').value || 'sports_car');
        params.set('days', document.getElementById('days').value || 30);
        params.set('limit', document.getElementById('limit').value || 20);
        const minIr = document.getElementById('minIr').value;
        if (minIr) params.set('min_current_irating', minIr);

        const res = await fetch(`/drivers-scout/api/leaders/growers?${params.toString()}`, {
            headers: {'X-License-Key': licenseKey}
        });
        if (!res.ok) {
            setLoading(false)
            alert('Request failed');
            return;
        }
        const data = await res.json();
        renderTimeRange(data.start_date_used, data.end_date_used);
        const rows = data.results || [];
        if (rows.length) {
            results.hidden = false;
        }
        renderChart(rows);
        renderTable(rows);
        setLoading(false)
    }

    function renderChart(rows) {
        const ctx = document.getElementById('chart');
        const points = rows.map(r => ({
            x: r.end_value,
            y: r.delta,
            label: r.driver || `#${r.cust_id}`,
            data: r
        }));
        if (chart) chart.destroy();
        chart = new Chart(ctx, {
            type: 'scatter',
            data: {datasets: [{label: 'Gainers', data: points, backgroundColor: '#38bdf8'}]},
            options: {
                scales: {
                    x: {title: {display: true, text: 'Current iRating'}},
                    y: {title: {display: true, text: 'Δ iRating'}}
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: ctx => {
                                const d = ctx.raw.data;
                                return [
                                    `Driver: ${d.driver || 'N/A'}`,
                                    `Current iRating: ${d.end_value}`,
                                    `Δ iRating: ${d.delta}`,
                                    `Starts: ${d.starts ?? 'N/A'}`,
                                    `Wins: ${d.wins ?? 'N/A'}`
                                ];
                            }
                        }
                    }
                },
                hover: {mode: 'nearest', intersect: true}
            }
        });
    }

    function renderTable(rows) {
        tableBody.innerHTML = '';
        rows.slice(0, 20).forEach((r, idx) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${r.driver || 'N/A'}</td>
          <td>${r.end_value}</td>
          <td>${r.delta}</td>
          <td>${r.percent_change ? r.percent_change.toFixed(2) + '%' : '—'}</td>
          <td>${r.starts ?? '—'}</td>
          <td>${r.wins ?? '—'}</td>
          <td>${r.location || '—'}</td>`;
            tableBody.appendChild(tr);
        });
    }

    checkLicense(licenseKey);
    licenseCheck.addEventListener('click', () => checkLicense(licenseInput.value.trim()));
    runQuery.addEventListener('click', loadGainers);

    document.getElementById('year').textContent = new Date().getFullYear();
</script>
</body>
</html>
